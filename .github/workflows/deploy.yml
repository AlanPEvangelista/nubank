name: Deploy para 192.168.100.117

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-and-deploy:
    # Executa para releases cujo target seja main, ou manual via workflow_dispatch
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.release.target_commitish == 'master' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instalar dependências
        run: npm install

      - name: Definir VITE_API_URL (fallback)
        run: |
          if [ -n "${{ secrets.VITE_API_URL }}" ]; then
            echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> $GITHUB_ENV
          else
            echo "VITE_API_URL=http://192.168.100.117:3001" >> $GITHUB_ENV
          fi

      - name: Build
        run: npm run build
        env:
          VITE_API_URL: ${{ env.VITE_API_URL }}

      - name: Publicar artefatos (opcional)
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

      - name: Copiar build para o servidor
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          source: "dist/*"
          target: "/home/alan/nubank_trae"

      - name: Copiar backend para o servidor
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          source: |
            server/**
            package.json
            package-lock.json
            vite.config.js
          target: "/home/alan/nubank_trae"

      - name: Instalar serviços systemd (backend e frontend)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            APP_DIR=/home/alan/nubank_trae
            BACKEND_USER=alan
            DB_PATH=${DB_PATH:-$APP_DIR/data/nubank.sqlite}
            BACKEND_PORT=${PORT:-3001}
            FRONT_PORT=${FRONT_PORT:-8082}
            HOST=${HOST:-0.0.0.0}
            NODE_BIN=$(command -v node || echo /usr/bin/node)
            VITE_BIN="$APP_DIR/node_modules/vite/bin/vite.js"
            echo "[systemd] Gerando serviços com APP_DIR=$APP_DIR USER=$BACKEND_USER"
            # Backend service
            cat > /tmp/nubank-backend.service <<EOF
            [Unit]
            Description=Nubank Backend
            After=network.target

            [Service]
            WorkingDirectory=$APP_DIR
            Environment=DB_PATH=$DB_PATH
            Environment=PORT=$BACKEND_PORT
            Environment=HOST=$HOST
            ExecStart=$NODE_BIN $APP_DIR/server/index.js
            Restart=always
            RestartSec=5
            User=$BACKEND_USER

            [Install]
            WantedBy=multi-user.target
            EOF

            # Frontend service (Vite Preview)
            cat > /tmp/nubank-frontend.service <<EOF
            [Unit]
            Description=Nubank Frontend
            After=network.target

            [Service]
            WorkingDirectory=$APP_DIR
            ExecStart=$NODE_BIN $VITE_BIN preview --host 0.0.0.0 --port $FRONT_PORT
            Restart=always
            RestartSec=5
            User=$BACKEND_USER

            [Install]
            WantedBy=multi-user.target
            EOF

            echo "Instalando serviços em /etc/systemd/system"
            echo "${{ secrets.SSH_PASSWORD }}" | sudo -S mv /tmp/nubank-backend.service /etc/systemd/system/nubank-backend.service
            echo "${{ secrets.SSH_PASSWORD }}" | sudo -S mv /tmp/nubank-frontend.service /etc/systemd/system/nubank-frontend.service
            echo "${{ secrets.SSH_PASSWORD }}" | sudo -S systemctl daemon-reload
            echo "${{ secrets.SSH_PASSWORD }}" | sudo -S systemctl enable --now nubank-backend.service
            echo "${{ secrets.SSH_PASSWORD }}" | sudo -S systemctl enable --now nubank-frontend.service
            echo "Serviços systemd instalados e iniciados"

      - name: Instalar dependências e iniciar backend (fallback)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            APP_DIR=/home/alan/nubank_trae
            DB_PATH=${DB_PATH:-$APP_DIR/data/nubank.sqlite}
            PORT=${PORT:-3001}
            HOST=${HOST:-0.0.0.0}
            echo "[1/4] Preparando diretório de dados"
            mkdir -p "$(dirname "$DB_PATH")"
            echo "[2/4] Instalando dependências"
            cd "$APP_DIR"
            npm ci
            echo "[3/4] Verificando systemd e serviços"
            if command -v systemctl >/dev/null 2>&1; then
              echo "${{ secrets.SSH_PASSWORD }}" | sudo -S systemctl restart nubank-backend.service || true
              echo "${{ secrets.SSH_PASSWORD }}" | sudo -S systemctl restart nubank-frontend.service || true
              echo "[4/4] Health: http://192.168.100.117:$PORT/health"
            else
              echo "systemd indisponível, usando fallback PM2/nohup"
              if command -v pm2 >/dev/null 2>&1; then
                if pm2 list | grep -q 'nubank-api'; then
                  DB_PATH="$DB_PATH" PORT="$PORT" HOST="$HOST" pm2 restart nubank-api --update-env
                else
                  DB_PATH="$DB_PATH" PORT="$PORT" HOST="$HOST" pm2 start server/index.js --name nubank-api
                fi
                pm2 save || true
              else
                DB_PATH="$DB_PATH" PORT="$PORT" HOST="$HOST" nohup node server/index.js >/home/alan/nubank_trae/backend.log 2>&1 &
              fi
              # Frontend fallback: Vite Preview
              nohup $NODE_BIN $APP_DIR/node_modules/vite/bin/vite.js preview --host 0.0.0.0 --port ${FRONT_PORT:-8082} > $APP_DIR/frontend.log 2>&1 &
              echo "[4/4] Backend rodando (fallback). Health: http://192.168.100.117:$PORT/health"
            fi